import{i as O}from"./crypto-vendor-DLELI0UM.js";const p=(e,n)=>n.some(t=>e instanceof t);let S,E;function v(){return S||(S=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function C(){return E||(E=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const m=new WeakMap,g=new WeakMap,w=new WeakMap;function L(e){const n=new Promise((t,r)=>{const s=()=>{e.removeEventListener("success",a),e.removeEventListener("error",i)},a=()=>{t(f(e.result)),s()},i=()=>{r(e.error),s()};e.addEventListener("success",a),e.addEventListener("error",i)});return w.set(n,e),n}function _(e){if(m.has(e))return;const n=new Promise((t,r)=>{const s=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",i),e.removeEventListener("abort",i)},a=()=>{t(),s()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",a),e.addEventListener("error",i),e.addEventListener("abort",i)});m.set(e,n)}let D={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return m.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return f(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function P(e){D=e(D)}function $(e){return C().includes(e)?function(...n){return e.apply(I(this),n),f(this.request)}:function(...n){return f(e.apply(I(this),n))}}function k(e){return typeof e=="function"?$(e):(e instanceof IDBTransaction&&_(e),p(e,v())?new Proxy(e,D):e)}function f(e){if(e instanceof IDBRequest)return L(e);if(g.has(e))return g.get(e);const n=k(e);return n!==e&&(g.set(e,n),w.set(n,e)),n}const I=e=>w.get(e);function T(e,n,{blocked:t,upgrade:r,blocking:s,terminated:a}={}){const i=indexedDB.open(e,n),c=f(i);return r&&i.addEventListener("upgradeneeded",o=>{r(f(i.result),o.oldVersion,o.newVersion,f(i.transaction),o)}),t&&i.addEventListener("blocked",o=>t(o.oldVersion,o.newVersion,o)),c.then(o=>{a&&o.addEventListener("close",()=>a()),s&&o.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),c}const W=["get","getKey","getAll","getAllKeys","count"],j=["put","add","delete","clear"],h=new Map;function B(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(h.get(n))return h.get(n);const t=n.replace(/FromIndex$/,""),r=n!==t,s=j.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(s||W.includes(t)))return;const a=async function(i,...c){const o=this.transaction(i,s?"readwrite":"readonly");let u=o.store;return r&&(u=u.index(c.shift())),(await Promise.all([u[t](...c),s&&o.done]))[0]};return h.set(n,a),a}P(e=>({...e,get:(n,t,r)=>B(n,t)||e.get(n,t,r),has:(n,t)=>!!B(n,t)||e.has(n,t)}));const V=["continue","continuePrimaryKey","advance"],A={},b=new WeakMap,K=new WeakMap,F={get(e,n){if(!V.includes(n))return e[n];let t=A[n];return t||(t=A[n]=function(...r){b.set(this,K.get(this)[n](...r))}),t}};async function*N(...e){let n=this;if(n instanceof IDBCursor||(n=await n.openCursor(...e)),!n)return;n=n;const t=new Proxy(n,F);for(K.set(t,n),w.set(t,I(n));n;)yield t,n=await(b.get(t)||n.continue()),b.delete(t)}function M(e,n){return n===Symbol.asyncIterator&&p(e,[IDBIndex,IDBObjectStore,IDBCursor])||n==="iterate"&&p(e,[IDBIndex,IDBObjectStore])}P(e=>({...e,get(n,t,r){return M(n,t)?N:e.get(n,t,r)},has(n,t){return M(n,t)||e.has(n,t)}}));let y=null;async function R(){return y||(y=(async()=>{try{return(await(await O.load()).get()).visitorId}catch(e){console.error("[DeviceFingerprint] 生成设备指纹失败",e);const n=`${navigator.userAgent}-${screen.width}x${screen.height}-${navigator.language}`,t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(a=>a.toString(16).padStart(2,"0")).join("")}})(),y)}const U="anynote-keys",G=1,d="keys";async function l(){return T(U,G,{upgrade(e){e.objectStoreNames.contains(d)||e.createObjectStore(d,{keyPath:"deviceId"})}})}async function H(){return crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["wrapKey","unwrapKey"])}async function X(){const e=await l(),n=await e.get(d,"__wrapping_key__");if(n&&n.wrappingKey)return n.wrappingKey;const t=await H();return await e.put(d,{deviceId:"__wrapping_key__",wrappingKey:t,expiresAt:0}),t}async function z(e,n,t){const r=await l(),s=await X(),a=crypto.getRandomValues(new Uint8Array(12)),i=await crypto.subtle.wrapKey("raw",n,s,{name:"AES-GCM",iv:a}),c=await R(),o={deviceId:e,wrappedKey:i,iv:a,expiresAt:t,fingerprint:c};await r.put(d,o)}async function J(e){await(await l()).delete(d,e)}async function Q(){const n=(await l()).transaction(d,"readwrite");await n.objectStore(d).clear(),await n.done}async function Z(e){const t=await(await l()).get(d,e);return t?t.expiresAt:null}const x="anynote-device-id";function q(){let e=localStorage.getItem(x);return e||(e=crypto.randomUUID(),localStorage.setItem(x,e)),e}function ee(){const e=navigator.userAgent;let n="💻",t="Unknown Browser";e.includes("Edg/")||e.includes("Edge/")?t="Edge":e.includes("Chrome/")&&!e.includes("Chromium")?t="Chrome":e.includes("Firefox/")?t="Firefox":e.includes("Safari/")&&!e.includes("Chrome")?t="Safari":(e.includes("Opera/")||e.includes("OPR/"))&&(t="Opera");let r="Unknown OS";if(e.includes("iPhone")||e.includes("iPad")||e.includes("iPod")){n="📱",r="iOS";const o=e.match(/OS (\d+)[._]\d+/);o&&(r=`iOS ${o[1]}`)}else if(e.includes("Android")){n="📱",r="Android";const o=e.match(/Android (\d+(?:\.\d+)?)/);o&&(r=`Android ${o[1]}`)}else e.includes("Windows")?(r="Windows",e.includes("Windows NT 10.0")&&(r="Windows 10/11")):e.includes("Mac OS X")||e.includes("Macintosh")?r="macOS":e.includes("Linux")&&(r="Linux");const s=new Date,a=String(s.getMonth()+1).padStart(2,"0"),i=String(s.getDate()).padStart(2,"0"),c=`${a}/${i}`;return`${n} ${t} (${r}) - ${c}`}export{ee as a,Z as b,Q as c,J as d,q as g,z as s};
//# sourceMappingURL=device-C8OUsEf4.js.map
